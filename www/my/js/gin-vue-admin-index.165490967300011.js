/*! 
 Build based on gin-vue-admin 
 Time : 1654909673000 */
var e=Object.defineProperty,t=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,l=Object.prototype.propertyIsEnumerable,o=(t,a,l)=>a in t?e(t,a,{enumerable:!0,configurable:!0,writable:!0,value:l}):t[a]=l,n=(e,t,a)=>new Promise(((l,o)=>{var n=e=>{try{s(a.next(e))}catch(t){o(t)}},i=e=>{try{s(a.throw(e))}catch(t){o(t)}},s=e=>e.done?l(e.value):Promise.resolve(e.value).then(n,i);s((a=a.apply(e,t)).next())}));import{W as i,_ as s,r,v as u,c as d,o as c,d as p,f as m,h,g,m as f,p as v,j as y,e as b,L as w,t as x,M as z,X as U}from"../gva/gin-vue-admin-index.1654909673000.js";class S{constructor(e,t,a=1920){this.file=e,this.fileSize=t,this.maxWH=a}compress(){const e=this.file.type,t=this.file.size/1024;return new Promise((a=>{const l=new FileReader;l.readAsDataURL(this.file),l.onload=()=>{const o=document.createElement("canvas"),n=document.createElement("img");n.src=l.result,n.onload=()=>{const l=o.getContext("2d"),i=this.dWH(n.width,n.height,this.maxWH);o.width=i.width,o.height=i.height,l.clearRect(0,0,o.width,o.height),l.drawImage(n,0,0,o.width,o.height);const s=o.toDataURL(e,.9),r=this.fileSizeKB(s);r>this.fileSize&&console.log("图片尺寸太大!"+t+" >> "+r);const u=this.dataURLtoBlob(s,e),d=new File([u],this.file.name);a(d)}}}))}dWH(e,t,a){const l={width:e,height:t};return Math.max(e,t)>a?e>t?(l.width=a,l.height=Math.round(t*(a/e)),l):(l.height=a,l.width=Math.round(e*(a/t)),l):l}fileSizeKB(e){let t=0;return t=Math.round(3*e.split(",")[1].length/4/1024),t}dataURLtoBlob(e,t){const a=atob(e.split(",")[1]);let l=e.split(",")[0].split(":")[1].split(";")[0];const o=new ArrayBuffer(a.length),n=new Uint8Array(o);for(let i=0;i<a.length;i++)n[i]=a.charCodeAt(i);return t&&(l=t),new Blob([o],{type:l,lastModifiedDate:new Date})}}const j=f("压缩上传"),_={name:"UploadImage",methods:{}};var k=s(Object.assign(_,{props:{imageUrl:{type:String,default:""},fileSize:{type:Number,default:2048},maxWH:{type:Number,default:1920}},emits:["on-success"],setup(e,{emit:t}){const a=e,l=r("/api"),o=u(),n=e=>{const t="image/jpeg"===e.type,l="image/png"===e.type;if(!t&&!l)return v.error("上传头像图片只能是 jpg或png 格式!"),!1;const o=e.size/1024<a.fileSize;if(!o){return new S(e,a.fileSize,a.maxWH).compress()}return o},i=e=>{const{data:a}=e;a.file&&t("on-success",a.file.url)};return(e,t)=>{const a=d("el-button"),s=d("el-upload");return c(),p("div",null,[m(s,{action:`${l.value}/fileUploadAndDownload/upload`,headers:{"x-token":g(o).token},"show-file-list":!1,"on-success":i,"before-upload":n,multiple:!1},{default:h((()=>[m(a,{size:"small",type:"primary"},{default:h((()=>[j])),_:1})])),_:1},8,["action","headers"])])}}}),[["__scopeId","data-v-15c9badb"]]);const C=f("普通上传"),O={name:"UploadCommon",methods:{}},B=Object.assign(O,{emits:["on-success"],setup(e,{emit:t}){const a=r("/api"),l=u(),o=r(!1),n=e=>{o.value=!0;const t="image/jpeg"===e.type,a="image/png"===e.type,l=e.size/1024/1024<.5;return t||a||(v.error("上传图片只能是 jpg或png 格式!"),o.value=!1),l||(v.error("未压缩未见上传图片大小不能超过 500KB，请使用压缩上传"),o.value=!1),(a||t)&&l},i=e=>{const{data:a}=e;a.file&&t("on-success",a.file.url)},s=()=>{v({type:"error",message:"上传失败"}),o.value=!1};return(e,t)=>{const o=d("el-button"),r=d("el-upload");return c(),p("div",null,[m(r,{action:`${a.value}/fileUploadAndDownload/upload`,"before-upload":n,headers:{"x-token":g(l).token},"on-error":s,"on-success":i,"show-file-list":!1,class:"upload-btn"},{default:h((()=>[m(o,{size:"small",type:"primary"},{default:h((()=>[C])),_:1})])),_:1},8,["action","headers"])])}}});const A={class:"gva-btn-list"},D=f("查询"),M={class:"media"},P={class:"header-img-box-list"},V={class:"header-img-box-list"},W=b("picture",null,null,-1),H=["onClick"],I={props:{target:{type:Object,default:null},targetKey:{type:String,default:""}},emits:["enterImg"],setup(e,{expose:s,emit:u}){const g=r(""),f=r(""),S=r({}),j=r(1),_=r(0),C=r(20);r("");const O=e=>{C.value=e,K()},I=e=>{j.value=e,K()},L=r(!1),R=r([]),F=r("/api"),K=()=>n(this,null,(function*(){const e=yield(n=((e,n)=>{for(var i in n||(n={}))a.call(n,i)&&o(e,i,n[i]);if(t)for(var i of t(n))l.call(n,i)&&o(e,i,n[i]);return e})({page:j.value,pageSize:C.value},S.value),i({url:"/fileUploadAndDownload/getFileList",method:"post",data:n}));var n;0===e.code&&(R.value=e.data.list,_.value=e.data.total,j.value=e.data.page,C.value=e.data.pageSize,L.value=!0)})),E=e=>n(this,null,(function*(){U.prompt("请输入文件名或者备注","编辑",{confirmButtonText:"确定",cancelButtonText:"取消",inputPattern:/\S/,inputErrorMessage:"不能为空",inputValue:e.name}).then((t=>n(this,[t],(function*({value:t}){e.name=t;var a;0===(yield(a=e,i({url:"/fileUploadAndDownload/editFileName",method:"post",data:a}))).code&&(v({type:"success",message:"编辑成功!"}),K())})))).catch((()=>{v({type:"info",message:"取消修改"})}))}));return s({open:K}),(t,a)=>{const l=d("el-input"),o=d("el-form-item"),n=d("el-button"),i=d("el-form"),s=d("el-icon"),r=d("el-image"),v=d("el-pagination"),U=d("el-drawer");return c(),y(U,{modelValue:L.value,"onUpdate:modelValue":a[3]||(a[3]=e=>L.value=e),title:"媒体库",size:"650px"},{default:h((()=>[b("div",A,[m(B,{imageCommon:f.value,"onUpdate:imageCommon":a[0]||(a[0]=e=>f.value=e),class:"upload-btn-media-library",onOnSuccess:K},null,8,["imageCommon"]),m(k,{imageUrl:g.value,"onUpdate:imageUrl":a[1]||(a[1]=e=>g.value=e),"file-size":512,"max-w-h":1080,class:"upload-btn-media-library",onOnSuccess:K},null,8,["imageUrl"]),m(i,{ref:"searchForm",inline:!0,model:S.value},{default:h((()=>[m(o,{label:""},{default:h((()=>[m(l,{modelValue:S.value.keyword,"onUpdate:modelValue":a[2]||(a[2]=e=>S.value.keyword=e),class:"keyword",placeholder:"请输入文件名或备注"},null,8,["modelValue"])])),_:1}),m(o,null,{default:h((()=>[m(n,{size:"small",type:"primary",icon:"search",onClick:K},{default:h((()=>[D])),_:1})])),_:1})])),_:1},8,["model"])]),b("div",M,[(c(!0),p(z,null,w(R.value,((t,a)=>(c(),p("div",{key:a,class:"media-box"},[b("div",P,[(c(),y(r,{key:a,src:t.url&&"http"!==t.url.slice(0,4)?F.value+t.url:t.url,onClick:a=>{return l=t.url,o=e.target,n=e.targetKey,o&&n&&(o[n]=l),u("enterImg",l),void(L.value=!1);var l,o,n}},{error:h((()=>[b("div",V,[m(s,null,{default:h((()=>[W])),_:1})])])),_:2},1032,["src","onClick"]))]),b("div",{class:"img-title",onClick:e=>E(t)},x(t.name),9,H)])))),128))]),m(v,{"current-page":j.value,"page-size":C.value,total:_.value,style:{"justify-content":"center"},layout:"total, prev, pager, next, jumper",onCurrentChange:I,onSizeChange:O},null,8,["current-page","page-size","total"])])),_:1},8,["modelValue"])}}};export{I as _};
